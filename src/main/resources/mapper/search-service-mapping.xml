<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ns.sql.SearchMapper">

	<resultMap id="openingListRM" type="opening">
		<id property="no" column="o_no" />
		<result property="uEmail" column="u_email" />
		<result property="createdAt" column="o_createdAt" />
		<result property="careWay" column="o_careway" />
		<result property="sDate" column="o_sdate" />
		<result property="eDate" column="o_edate" />
		<result property="price" column="o_price" />
		<result property="per" column="o_per" />
		<result property="location" column="o_location" />
		<result property="close" column="o_close" />
		<collection property="pets" ofType="pet">
			<id property="no" column="p_no" />
			<result property="species" column="p_species" />
		</collection>
	</resultMap>

	<sql id="select-openings">
		SELECT
		o.o_no, o.u_email, o.o_createdAt, o.o_careway, o.o_sdate, o.o_edate, o.o_price, o.o_per, o.o_location, o.o_close, p.p_no, p.p_species
		FROM Opening o
		JOIN PostPet pp ON o.o_no = pp.o_no
		JOIN pet p ON pp.p_no = p.p_no
	</sql>

	<select id="searchOpenings" parameterType="condition" resultMap="openingListRM">
		<include refid="select-openings" />
		<where>
			o.o_createdAt &lt;= now()
			AND o.o_location = #{location}
			<if test="closeFilter == true">
				AND o.o_close != 1
			</if>
			<if test="sdate != null">
				AND o.o_sdate &gt;= #{sdate}
			</if>
			<if test="edate != null">
				AND o.o_edate &lt;= #{edate}
			</if>
			<if test="careWay != null">
				AND o.o_careway = #{careWay}
			</if>
			<if test="species != null">
				AND p.p_species = #{species}
			</if>
		</where>
		<choose>
			<when test="orderBy == 'old'">
				ORDER BY o.o_createdAt ASC
			</when>
			<when test="orderBy == 'price'">
				ORDER BY o.o_price DESC
			</when>
			<otherwise>
				ORDER BY o.o_createdAt DESC
			</otherwise>
		</choose>
	</select>

	<select id="searchLoc" parameterType="string" resultType="location">
		SELECT lcode, address
		FROM Location
		WHERE address LIKE concat('%', #{VALUE}, '%')
	</select>
</mapper>
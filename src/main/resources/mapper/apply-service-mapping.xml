<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ns.sql.ApplyMapper">
	<resultMap id="applyResultMap" type="Apply">
		<id property="no" column="a_no"/>
		<result property="uEmail" column="u_email"/>
		<result property="oNo" column="o_no"/>
		<result property="createdAt" column="a_createdAt"/>
		<result property="text" column="a_text"/>
		<result property="status" column="a_staus"/>
	</resultMap>

	<insert id="applyToOpening" parameterType="Apply">
		INSERT INTO Apply
		(u_email, o_no, a_createdAt, a_text, a_status)
		VALUES (#{uEmail}, #{oNo}, #{createdAt}, #{text}, 'pending');
	</insert>

	<select id="getApplicants" parameterType="Integer" resultType="ApplyUserDTO">
		SELECT
		a.a_no      AS aNo,
		a.o_no      AS oNo,
		a.a_text    AS aText,
		a.a_status  AS aStatus,
		a.a_createdAt AS aCreatedAt,
		u.u_email   AS uEmail,
		u.u_grade   AS uGrade,
		u.u_image   AS uImage
		FROM Apply a
		JOIN User u ON a.u_email = u.u_email
		WHERE a.o_no = #{value}
	</select>

	<update id="updateApplyStatus" parameterType="map">
		UPDATE Apply
		SET a_status = #{status}
		WHERE a_no = #{no}
	</update>

	<update id="rejectOthers">
		UPDATE Apply
		SET a_status = 'reject'
		WHERE o_no = #{oNo}
		AND a_no != #{aNo}
	</update>

	<select id="selectGenderStats" parameterType="int" resultType="map">
		SELECT
		SUM(CASE WHEN u.u_gender='f' THEN 1 ELSE 0 END) AS f,
		SUM(CASE WHEN u.u_gender='m' THEN 1 ELSE 0 END) AS m,
		SUM(CASE WHEN u.u_gender='n' OR u.u_gender IS NULL THEN 1 ELSE 0 END) AS n
		FROM apply a
		JOIN user u ON a.u_email = u.u_email
		WHERE a.o_no = #{value}
	</select>

	<select id="selectAgeGroupStats" parameterType="int" resultType="map">
		SELECT
		SUM(CASE WHEN u.u_bdate IS NOT NULL AND YEAR(u.u_bdate) > 0
		AND FLOOR((YEAR(CURDATE()) - YEAR(u.u_bdate)) / 10) * 10 = 20 THEN 1 ELSE 0 END) AS `20대`,
		SUM(CASE WHEN u.u_bdate IS NOT NULL AND YEAR(u.u_bdate) > 0
		AND FLOOR((YEAR(CURDATE()) - YEAR(u.u_bdate)) / 10) * 10 = 30 THEN 1 ELSE 0 END) AS `30대`,
		SUM(CASE WHEN u.u_bdate IS NOT NULL AND YEAR(u.u_bdate) > 0
		AND FLOOR((YEAR(CURDATE()) - YEAR(u.u_bdate)) / 10) * 10 = 40 THEN 1 ELSE 0 END) AS `40대`,
		SUM(CASE WHEN u.u_bdate IS NULL OR YEAR(u.u_bdate) = 0 THEN 1 ELSE 0 END) AS `미상`
		FROM apply a
		JOIN user u ON a.u_email = u.u_email
		WHERE a.o_no = #{value}
	</select>

	<select id="getApplyList" parameterType="String" resultType="ApplyUserDTO">
		SELECT
		a.a_no      AS aNo,
		a.o_no      AS oNo,
		a.a_text    AS aText,
		a.a_status  AS aStatus,
		a.a_createdAt AS aCreatedAt,
		u.u_email   AS uEmail,
		u.u_grade   AS uGrade,
		u.u_image   AS uImage
		FROM Apply a
		JOIN User u ON a.u_email = u.u_email
		WHERE a.u_email = #{value}
	</select>

	<select id="getApplyUserById" parameterType="int" resultType="ApplyUserDTO">
		SELECT a.a_no    AS aNo,
		a.o_no    AS oNo,
		a.u_email AS uEmail,
		a.a_status AS aStatus
		FROM apply a
		WHERE a.a_no = #{aNo}
	</select>
</mapper>

 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 